{% load static %}

<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <h3 class="text-xl font-semibold mb-4">{{ form_title|default:"Add Your Rating" }}</h3>
    
    <form method="post" enctype="multipart/form-data" id="rating-form" class="space-y-4" 
          action="{{ form_action|default:'' }}">
        {% csrf_token %}
        
        {{ form.non_field_errors }}
        {{ form.content_type }}
        {{ form.object_id }}
        
        <input type="hidden" name="next" value="{{ request.path }}">
        
        <!-- Overall Rating -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Overall Rating*</label>
            <div class="mb-1">
                {% include "ratings/components/star_input.html" with name="rating" value=form.rating.value|default:0 %}
            </div>
            {% if form.rating.errors %}
                <p class="text-red-500 text-sm">{{ form.rating.errors.0 }}</p>
            {% endif %}
        </div>
        
        <!-- Specific Rating Categories -->
        {% if form.has_specific_ratings %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                {% for field in form.specific_rating_fields %}
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">{{ field.label }}</label>
                        <div class="mb-1">
                            {% include "ratings/components/star_input.html" with name=field.name value=field.value|default:0 %}
                        </div>
                        {% if field.errors %}
                            <p class="text-red-500 text-sm">{{ field.errors.0 }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Title -->
        <div class="mb-4">
            <label for="{{ form.title.id_for_label }}" class="block text-gray-700 font-medium mb-2">Title*</label>
            <input type="text" name="{{ form.title.name }}" id="{{ form.title.id_for_label }}" 
                   value="{{ form.title.value|default:'' }}"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Summarize your experience">
            {% if form.title.errors %}
                <p class="text-red-500 text-sm">{{ form.title.errors.0 }}</p>
            {% endif %}
        </div>
        
        <!-- Comment -->
        <div class="mb-4">
            <label for="{{ form.comment.id_for_label }}" class="block text-gray-700 font-medium mb-2">Review*</label>
            <textarea name="{{ form.comment.name }}" id="{{ form.comment.id_for_label }}" rows="4"
                      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Share details of your experience">{{ form.comment.value|default:'' }}</textarea>
            {% if form.comment.errors %}
                <p class="text-red-500 text-sm">{{ form.comment.errors.0 }}</p>
            {% endif %}
        </div>
        
        <!-- Photos Upload -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Add Photos (Optional)</label>
            <div class="flex items-center justify-center w-full">
                <label for="photo-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="mb-1 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">PNG, JPG or JPEG (MAX. 5MB)</p>
                    </div>
                    <input id="photo-upload" name="photos" type="file" class="hidden" multiple accept="image/*">
                </label>
            </div>
            <div id="photo-preview" class="grid grid-cols-3 gap-4 mt-2"></div>
            {% if form.photos.errors %}
                <p class="text-red-500 text-sm">{{ form.photos.errors.0 }}</p>
            {% endif %}
        </div>
        
        <!-- Existing Photos (Edit mode) -->
        {% if form.instance and form.instance.photos.all %}
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">Current Photos</label>
                <div class="grid grid-cols-3 gap-4">
                    {% for photo in form.instance.photos.all %}
                        <div class="relative group">
                            <img src="{{ photo.image.url }}" alt="Rating photo" class="h-32 w-full object-cover rounded-lg">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 flex items-center justify-center transition-all duration-200 opacity-0 group-hover:opacity-100">
                                <button type="button" class="delete-photo-btn bg-red-600 text-white p-1 rounded-full"
                                        data-photo-id="{{ photo.id }}" data-url="{% url 'ratings:delete_photo' photo.id %}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        <div class="flex justify-end">
            {% if form.instance.id %}
                <button type="button" id="delete-rating-btn" class="mr-auto px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Delete
                </button>
            {% endif %}
            <a href="{{ cancel_url|default:request.META.HTTP_REFERER }}" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition mr-2">
                Cancel
            </a>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                {{ submit_text|default:"Submit Rating" }}
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Photo upload preview
        const photoInput = document.getElementById('photo-upload');
        const photoPreview = document.getElementById('photo-preview');
        
        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function() {
                photoPreview.innerHTML = '';
                
                if (this.files) {
                    Array.from(this.files).forEach(file => {
                        if (!file.type.match('image.*')) {
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const div = document.createElement('div');
                            div.className = 'relative';
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'h-32 w-full object-cover rounded-lg';
                            
                            div.appendChild(img);
                            photoPreview.appendChild(div);
                        };
                        
                        reader.readAsDataURL(file);
                    });
                }
            });
        }
        
        // Delete existing photo
        document.querySelectorAll('.delete-photo-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (confirm('Are you sure you want to delete this photo?')) {
                    const url = this.dataset.url;
                    const photoContainer = this.closest('.relative');
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        },
                    }).then(response => {
                        if (response.ok) {
                            photoContainer.remove();
                        } else {
                            alert('Failed to delete photo. Please try again.');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the photo.');
                    });
                }
            });
        });
        
        // Delete rating
        const deleteRatingBtn = document.getElementById('delete-rating-btn');
        if (deleteRatingBtn) {
            deleteRatingBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this rating? This action cannot be undone.')) {
                    const form = document.getElementById('rating-form');
                    const deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = 'delete';
                    deleteInput.value = 'true';
                    form.appendChild(deleteInput);
                    form.submit();
                }
            });
        }
    });
</script>
